---

- hosts: all
  vars:
    - stack_home: "/opt/stack"
    - os_faults_home: "/opt/stack/os-faults"
  tasks:

    - name: Home folder
      command: realpath ~
      register: real_stack_home
      ignore_errors: True
      become: yes
      become_user: stack

    - name: Create folder for SSH keys (as stack user)
      file:
        path: "{{ stack_home }}/.ssh"
        state: directory
        mode: 0755
      become: yes
      become_user: stack

    - name: Generate SSH key pair (as zuul user)
      command: "ssh-keygen -t rsa -f {{ os_faults_home }}/os_faults_key -N ''"

    - name: List os-faults folder
      command: "ls -al {{ os_faults_home }}"
      ignore_errors: True

    - name: Make authorized_keys
      shell: |
        cat {{ os_faults_home}}/os_faults_key.pub > {{ stack_home }}/.ssh/authorized_keys
      become: yes
      become_user: stack
      ignore_errors: True

    - name: List .ssh folder (as stack user)
      command: ls -al ~/.ssh
      ignore_errors: True
      become: yes
      become_user: stack

    - name: List .ssh folder (as stack user) (test)
      command: "ls -al {{ real_stack_home.stdout }}/.ssh"
      ignore_errors: True
      become: yes
      become_user: stack

    - name: Cat all files
      shell: |
        cd ~/.ssh
        ls | xargs cat
      ignore_errors: True
      become: yes
      become_user: stack

    - name: Try to connect to localhost
      command: "ssh -vvv -i os_faults_key -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -o ConnectTimeout=60 -o IdentitiesOnly=yes stack@localhost"
      args:
        chdir: "{{ os_faults_home }}"
      ignore_errors: True

    - name: Run integration tests (as zuul user)
      command: "tox -e {{tox_envlist}}"
      args:
        chdir: "{{ os_faults_home }}"
      ignore_errors: True

    - name: Try to inject fault
      shell: |
        cd /opt/stack/os-faults
        . .tox/devstack/bin/activate
        os-inject-fault -c /opt/stack/os-faults/os_faults/tests/devstack/os-faults-universal.yaml -vd
      ignore_errors: True
